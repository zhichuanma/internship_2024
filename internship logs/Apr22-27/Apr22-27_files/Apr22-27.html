<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Internship logs from Apr.22 to Apr.27</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Apr22-27_files/libs/clipboard/clipboard.min.js"></script>
<script src="Apr22-27_files/libs/quarto-html/quarto.js"></script>
<script src="Apr22-27_files/libs/quarto-html/popper.min.js"></script>
<script src="Apr22-27_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Apr22-27_files/libs/quarto-html/anchor.min.js"></script>
<link href="Apr22-27_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Apr22-27_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Apr22-27_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Apr22-27_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Apr22-27_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Internship logs from Apr.22 to Apr.27</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This week’s key point is to conclude the LCA methodology used in REHO.</p>
<p>Several questions to be answered:</p>
<ol type="1">
<li>What is REHO?</li>
<li>Current LCA situation in REHO?</li>
<li>LCA level we would like to reach in REHO?</li>
<li>Which technologies are pilots specific? Which ones are always the same whatever the geography?</li>
</ol>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">22/04/2024 - 24/04/2024</h2>
<p><strong>Materials read</strong>: Official website, <a href="https://reho.readthedocs.io/en/main/sections/3_Model.html">“Model” page</a></p>
<p><strong><span style="color: red;">For a delimited perimeter of buildings, REHO selects the optimal energy system configuration minimizing the specified objective function.</span></strong></p>
<p>Several energy demandes are considered:</p>
<ul>
<li>Thermal comfort</li>
<li>DHW</li>
<li>Domestic electricity</li>
<li>Mobility needs</li>
</ul>
<p>Domestic electricity, DHW, and mobility needs are generated using standardized profiles according to norms or measurements in a pre-processing step. -&gt; Typical profiles, a better understanding of energy consumer’s behavior</p>
<p><strong>Question: Why is thermal comfort “modeled within the framework itself”?</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Apr22-27_files/diagram_model.svg" class="img-fluid figure-img"></p>
<figcaption>model</figcaption>
</figure>
</div>
<section id="model-inputs" class="level3">
<h3 class="anchored" data-anchor-id="model-inputs">model inputs</h3>
<ul>
<li>EUDs, <strong>End Use Demands</strong>, from the meteorological data and the buildings characteristics</li>
<li>The <strong>resources</strong> to which it has access to provide those EUDs, namely grids</li>
<li><strong>the equipments</strong> that can be used to convert those resources into the required services</li>
</ul>
<section id="end-use-demand-profiles" class="level4">
<h4 class="anchored" data-anchor-id="end-use-demand-profiles">End use demand profiles</h4>
<ul>
<li>demand profile for domestic hot water</li>
<li>demand profile for domestic electricity</li>
<li>demand profile for spacing heating
<ul>
<li>internal heat gains from the occupancy</li>
<li>internal heat gains from electric appliances</li>
<li>heat exchange with the exterior</li>
<li>solar gains from the irradiance</li>
</ul></li>
</ul>
<p><strong>Question: Where is mobility?</strong></p>
<section id="building-characteristics-usage-type-morphology-and-heat-performance" class="level5">
<h5 class="anchored" data-anchor-id="building-characteristics-usage-type-morphology-and-heat-performance">Building characteristics (usage type, morphology and heat performance)</h5>
<section id="usage" class="level6">
<h6 class="anchored" data-anchor-id="usage">Usage</h6>
<p>I to XII, diffferent room type and usage</p>
</section>
<section id="morphology" class="level6">
<h6 class="anchored" data-anchor-id="morphology">Morphology</h6>
<ul>
<li>Energy reference area (ERA) <span class="math inline">\(A_{ERA}[m^{2}]\)</span></li>
<li>Roof Surfaces <span class="math inline">\(A_{roofs}[m^2]\)</span></li>
<li>Facades surfaces <span class="math inline">\(A_{surfaces}[m^2]\)</span></li>
<li>Glass fraction <span class="math inline">\(g^{glass}[-]\)</span></li>
</ul>
<p><strong>Question: What is energy surface area?</strong></p>
</section>
<section id="heating-performance" class="level6">
<h6 class="anchored" data-anchor-id="heating-performance">Heating performance</h6>
<ul>
<li>Year of construction or renovaion</li>
<li>Quality of thermal envelop
<ul>
<li>Overall heat transfer coefficient <span class="math inline">\(U_{h}[kW/K/m^2]\)</span></li>
<li>Heat capacity coefficient <span class="math inline">\(C_{h}[Wh/K/m^2]\)</span></li>
</ul></li>
<li>Temperatures of supply and return for heating system <span class="math inline">\(T_{h,supply} - T_{h, return}[{^\circ}C]\)</span></li>
<li>Temperatures of supply and return for cooling system <span class="math inline">\(T_{c,supply} - T_{c, return}[{^\circ}C]\)</span></li>
<li>Reference indoor temperature <span class="math inline">\(T_{in}[{^\circ}C]\)</span></li>
</ul>
<p><strong>Question: What means supply temperature and what means return temperature?</strong></p>
</section>
</section>
<section id="weather-data" class="level5">
<h5 class="anchored" data-anchor-id="weather-data">Weather data</h5>
<ul>
<li>Outdoor ambient temperature (yearly profile) <span class="math inline">\(T_{out}[^{\circ}C]\)</span></li>
<li>Global horizontal irradiation (yearly profile) <span class="math inline">\(Irr_{out}[^{\circ}C]\)</span></li>
</ul>
<p>They use k-medoids clustering algorithm in REHO. (global irradiation and ambient temperature)</p>
<p><strong>NB: Extreme periods are also considered, but only for the design of the capacities.</strong></p>
</section>
</section>
<section id="grids" class="level4">
<h4 class="anchored" data-anchor-id="grids">Grids</h4>
<p>In the REHO model, a grid is characterized by the energy carrier its transports and its specifications.</p>
<section id="energy-layers" class="level5">
<h5 class="anchored" data-anchor-id="energy-layers">Energy layers</h5>
<ul>
<li>Electricity</li>
<li>Natural gas</li>
<li>Oil</li>
<li>District heat</li>
<li>Data (ICT service)</li>
</ul>
<p><strong>Question: What is ICT service?</strong></p>
<p>These layers are modeled through parameters that can be changed in the model:</p>
<ul>
<li>import and export tariffs</li>
<li>carbon content</li>
<li>Environmental impact</li>
</ul>
<p><span style="color: red;">They only have 3 criterias for LCA:</span> - Land use - Human toxicity - Water pollutants</p>
</section>
<section id="specifications" class="level5">
<h5 class="anchored" data-anchor-id="specifications">Specifications</h5>
<p>Cost, environmental impact, maximal capacity for district imports and exports</p>
</section>
</section>
<section id="equipments" class="level4">
<h4 class="anchored" data-anchor-id="equipments">Equipments</h4>
<p>The units are parametrized by:</p>
<ul>
<li>Special cost (fixed and variable costs, valid for a limited range (<span class="math inline">\(f_{min}, f_{max}\)</span>))</li>
<li>Environmental impacts (= grey energy encompassing the manufacturing of the unit, and distributed over the lifetime of the unit)</li>
<li>Thermodynamics properties (efficiency, temperature f operation)</li>
</ul>
<p><img src="Apr22-27_files/building_level.png" class="img-fluid" alt="Building level overview"> <img src="Apr22-27_files/district_level.png" class="img-fluid" alt="District level overview"></p>
</section>
</section>
<section id="model" class="level3">
<h3 class="anchored" data-anchor-id="model">Model</h3>
<p>As objectives can be generally competing, the problem can be approached using a Multi-Objective Optimization (MOO) approach. MOO is implemented using the <span class="math inline">\(\epsilon\)</span> -constraint method to generate Pareto curves.</p>
<p>For the details, see the website. (There are some mistakes but still understandable)</p>
<p><strong>Questions</strong>: - relationship between typical periods and time - <strong>what is literation intervals</strong> - what is l? layers or linearization time? - what is b? what means bare module?</p>
<section id="objective-function" class="level4">
<h4 class="anchored" data-anchor-id="objective-function">Objective function</h4>
<section id="annual-operating-expenses" class="level5">
<h5 class="anchored" data-anchor-id="annual-operating-expenses">Annual operating expenses</h5>
<p>energy import tariff - energy output tarrif during one year</p>
<p>when “gr” and “+” together means the electricity from the grid</p>
<p>when “gr” and “-” together means the electricity to the grid</p>
<p><strong>This is wrong:</strong> Resource -[supply]-&gt; grid -[demand]-&gt; residence</p>
</section>
<section id="annual-capital-expenses" class="level5">
<h5 class="anchored" data-anchor-id="annual-capital-expenses">Annual capital expenses</h5>
<p>capital cost = invest + replacement</p>
<p>invest = bare module * (fixed investment cost * use or not decision variable + continuous investment cost * size)</p>
<p>replacement = similar to invest</p>
</section>
<section id="annual-total-expenses" class="level5">
<h5 class="anchored" data-anchor-id="annual-total-expenses">Annual total expenses</h5>
<p>total = capital + operation</p>
</section>
<section id="global-warming-potential" class="level5">
<h5 class="anchored" data-anchor-id="global-warming-potential">Global warming potential</h5>
<p>bes = building energy system</p>
<p><span class="math inline">\(gwp_{op}\)</span> = import tarrif - output tarrif</p>
<p><span class="math inline">\(gwp_{bes}\)</span> = bare module * (fixed gwp * use or not decision variable + continuous gwp * size)</p>
</section>
</section>
<section id="building-level-constraints" class="level4">
<h4 class="anchored" data-anchor-id="building-level-constraints">Building level constraints</h4>
<section id="sizing-constraints" class="level5">
<h5 class="anchored" data-anchor-id="sizing-constraints">Sizing constraints</h5>
<p>size f is limitted to a feasible range.</p>
</section>
<section id="energy-balance" class="level5">
<h5 class="anchored" data-anchor-id="energy-balance">Energy balance</h5>
<p>energy obtained from the renewable resources + energy from the grid = energy to the grid + energy consumed by units + energy consumed by buildings</p>
<p>Fresh water or natural gas supply = its demand</p>
</section>
<section id="heat-casade" class="level5">
<h5 class="anchored" data-anchor-id="heat-casade">Heat casade</h5>
<p>the change of residual heat = heating - cooling</p>
<p>boundary condition</p>
</section>
<section id="thermal-comfort" class="level5">
<h5 class="anchored" data-anchor-id="thermal-comfort">Thermal comfort</h5>
<p>Space heating = heat gained - heat exchange from internal to external - stored heat change with time</p>
<p>heat gain = heat originated from units + irradiation</p>
<p>heat originated from units calculation is based on SIA 2024:2015 and include the rooms usage</p>
<p>heat obtained from irradiation is easy to handle with</p>
<p><strong>Note: The internal building temperature is considered as a variable to be optimized. This allows the building heat capacity to work as an additional, free thermal storage for the building energy system, thus making it possible to use available surplus electricity, which was generated onsite</strong></p>
<p>There will also be a comfort penalty cost in objective function in objective function.</p>
</section>
<section id="domestic-hot-water" class="level5">
<h5 class="anchored" data-anchor-id="domestic-hot-water">Domestic hot water</h5>
</section>
<section id="domestic-electricity" class="level5">
<h5 class="anchored" data-anchor-id="domestic-electricity">Domestic electricity</h5>
</section>
</section>
<section id="district-level-constraints" class="level4">
<h4 class="anchored" data-anchor-id="district-level-constraints">District-level constraints</h4>
<p>Dantzig-Wolfe algorithm</p>
<p>I spent some time on this algorithm. Basically it decomposed this question to sub problems according to buildings. It will solve the problem iteratively until it is convergent.</p>
<p>Original metrics =&gt; master problem + sub problems</p>
<p>sub problems will return information (base variables and corresbonding conlumns) to the master problem and master problem will update its information (objective function, constraints matrics and bases) and solve to get the dual variables. Dual variables will be given to the sub problems again to update their objective functions.</p>
</section>
<section id="grid-capacity" class="level4">
<h4 class="anchored" data-anchor-id="grid-capacity">Grid Capacity</h4>
<p>energy from grid to buildings - energy from buildings to grid = energy from outside</p>
</section>
</section>
<section id="outputs" class="level3">
<h3 class="anchored" data-anchor-id="outputs">Outputs</h3>
<p>Decision variables:</p>
<p>Installed capacities for building-level and district-level units</p>
<p>Operation time throughout a year</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<section id="relevance-between-lca-and-cost" class="level4">
<h4 class="anchored" data-anchor-id="relevance-between-lca-and-cost">Relevance between LCA and cost</h4>
<p>In the REHO framework, LCA indicators are treated similarly to cost calculations. Although the analogy may not seem obvious from the formulas related to life cycle assessment, I will clarify the similarities with a simple example.</p>
<p>Essentially, when constructing units, such as carbon capture systems, we invest money with the expectation of earning returns. Similarly, we expend carbon footprints on this equipment, hoping to capture carbon emissions in return.</p>
<p>From a broader perspective, we invest both money and carbon footprints in our systems.</p>
<p>For energy, the cost is calculated as the price paid for electricity purchased from the grid minus the revenue from electricity sold back to the grid. The GWP (Global Warming Potential) calculation follows a similar principle: the carbon footprints associated with electricity purchased from the grid are offset by the carbon footprints credited back for the electricity returned to the grid.</p>
<p>Regarding the units, costs are calculated by summing the fixed costs and the variable costs, which depend on the unit size. Similarly, CO2 emissions are calculated as the sum of the fixed carbon investment plus the variable carbon emissions based on unit size.</p>
</section>
<section id="what-should-i-focus-on-in-the-scripts-reading" class="level4">
<h4 class="anchored" data-anchor-id="what-should-i-focus-on-in-the-scripts-reading">What should I focus on in the scripts reading?</h4>
<ol type="1">
<li>what they use as the fixed environmental impact and continuous environmental impact?</li>
<li>According to the reading, they didnt achieve the MOO. (The GWP objective function is isolated with the annual total expenses)</li>
<li>The LCA status I am able to contribute:
<ul>
<li>Relying only on Global Warming Potential (GWP) is insufficient for a comprehensive environmental impact assessment. A broader range of environmental indicators is necessary to capture the full impact.</li>
<li>Based on previous studies, there is a noticeable scale effect in the manufacturing of these units, indicating that the relationship between the size of the units and their environmental and cost impacts is not linear. This complexity needs to be accurately modeled in the LCA.</li>
<li>While the cost analysis includes a provision for “replacement cost,” the environmental impact assessments fail to include a corresponding environmental cost for replacement activities. This omission could lead to an underestimation of the environmental impacts over the lifecycle of the units.</li>
</ul></li>
</ol>
</section>
</section>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1">25/04/2024 - 26/04/2024</h2>
<section id="scripts-reading" class="level3">
<h3 class="anchored" data-anchor-id="scripts-reading">Scripts reading</h3>
<p><strong>Combine the “package structure” in the official website</strong></p>
<p><strong>Objective for scripts reading</strong>: Read the results filefolders and understand each function and parameter in these functions. Learn how to use these scripts.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Apr22-27_files/Diagram_REHO.svg" class="img-fluid figure-img"></p>
<figcaption>Diagram of REHO architecture</figcaption>
</figure>
</div>
<p>Indeed, based on the diagram, we have been able to see what are the model’s inputs and outputs, as well as its algorithm.</p>
<section id="data" class="level4">
<h4 class="anchored" data-anchor-id="data">data/</h4>
<section id="elcom" class="level5">
<h5 class="anchored" data-anchor-id="elcom">elcom/</h5>
<p>id + commune + operator</p>
</section>
<section id="emissions" class="level5">
<h5 class="anchored" data-anchor-id="emissions">emissions/</h5>
<p><strong>Question: what are the meaning of the columns? And I also would like to know the source of these datas. Since they are different from what I see in the ecoinvent.</strong></p>
</section>
<section id="infrastructure" class="level5">
<h5 class="anchored" data-anchor-id="infrastructure">infrastructure/</h5>
<p>This filefolder contains a lot of information related to units. Nevertheless,</p>
<ul>
<li>in building_units.csv and district_units.csv, for the LCA part, they have 13 kinds of LCA indicators and for each indicator they use “xxx_1” &amp; “xxx_2”. I guess it means the “fixed environmental impacts” and “continuous environmental impacts”.</li>
<li>in grids.csv, the demand cost for environmental impacts are nearly 0 compared to the supply cost.</li>
<li>HP_parameters.txt is super confusing for the 1st column and 2nd column.</li>
<li>storage_units.csv: everything related to lifecycle impacts is 0</li>
</ul>
<p><strong>Question: Same with last question</strong></p>
</section>
<section id="qbbuildings" class="level5">
<h5 class="anchored" data-anchor-id="qbbuildings">QBbuildings/</h5>
<p>Tried to log in but failed.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Apr22-27_files/database.png" class="img-fluid figure-img"></p>
<figcaption>failure</figcaption>
</figure>
</div>
</section>
<section id="sia" class="level5">
<h5 class="anchored" data-anchor-id="sia">SIA/</h5>
<p>There are 2 csv files inside: 1 for properties for different types of rooms; 1 for the rooms compositions for different buildings. Everything is in French.</p>
</section>
<section id="skydome" class="level5">
<h5 class="anchored" data-anchor-id="skydome">skydome/</h5>
<p>irradiation data is based on the data in 2005.</p>
</section>
<section id="weather" class="level5">
<h5 class="anchored" data-anchor-id="weather">weather/</h5>
<p>datasets for weather.</p>
</section>
</section>
<section id="model-1" class="level4">
<h4 class="anchored" data-anchor-id="model-1">model/</h4>
<pre class="{matlab}"><code>param penalty_ratio default 1e-6;
var penalties default 0;

subject to penalties_contraints:
penalties = penalty_ratio * (Costs_inv + Costs_op + sum{k in Lca_kpi} lca_tot[k] +
            sum{l in ResourceBalances,p in PeriodExtrem,t in Time[p]} (Network_supply[l,p,t] + Network_demand[l,p,t])) + Costs_cft;

# objective functions
minimize TOTEX:
Costs_tot + Costs_grid_connection + penalties;

minimize OPEX:
Costs_op + Costs_grid_connection + penalties;

minimize CAPEX: # the second term is added to correspond to objective set in design_cst
Costs_inv + penalties;

minimize GWP:
GWP_tot + penalties;

minimize Human_toxicity:
lca_tot["Human_toxicity"] + penalties;

minimize land_use:
lca_tot["land_use"] + penalties;
</code></pre>
<ul>
<li>In the objective functions, we choose a objective to optimize. It’s not like we optimize every objective together.</li>
<li>Indeed the “+penalties” means the integration of LCA with the cost but for now the penalties are almost 0.</li>
<li>Cost_cft is the comfort penalties.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Apr22-27_files/difference%20between%20district%20and%20building.png" class="img-fluid figure-img"></p>
<figcaption>difference between districts and buildings</figcaption>
</figure>
</div>
<p>input: - scenario: - objective (opex, capex, totex, …), with 2 objectives, you will draw a Pareto curve(indeed I am not sure if it’s pareto curve. There will be some things more like a sankey or ba) -</p>
<p>To be continued</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>